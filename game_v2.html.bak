<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARPG Prototype</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Arial', sans-serif;
            color: white;
            user-select: none;
        }

        canvas {
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* HUD */
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }

        .bar-container {
            width: 300px;
            height: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #444;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.2s;
        }

        #hp-bar-fill {
            background: linear-gradient(90deg, #ff4444, #cc0000);
            width: 100%;
        }

        #xp-bar-fill {
            background: linear-gradient(90deg, #44ff44, #00cc00);
            width: 0%;
        }

        #energy-bar-fill {
            background: linear-gradient(90deg, #4444ff, #0000cc);
            width: 100%;
        }

        .bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            z-index: 1;
        }

        /* Skill Bar */
        #skill-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }

        .skill-slot {
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #666;
            border-radius: 8px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #fff;
            overflow: hidden;
        }

        .skill-slot.active {
            border-color: #ffff00;
            box-shadow: 0 0 10px #ffff00;
        }

        .skill-key {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 10px;
            color: #aaa;
        }

        .skill-cd {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: rgba(0, 0, 0, 0.8);
            transition: height 0.1s linear;
        }

        /* Stat Panel */
        #statPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 600px;
            background: rgba(20, 20, 30, 0.95);
            border: 2px solid #666;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            padding: 20px;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            z-index: 100;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .panel-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #333;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }

        .tab-btn.active {
            background: #555;
            color: #fff;
            box-shadow: 0 0 5px #555;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .stat-btn {
            background: #4CAF50;
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            margin-left: 10px;
        }

        /* Inventory */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .inv-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .inv-name {
            font-weight: bold;
        }

        .inv-btn {
            background: #444;
            border: none;
            color: white;
            padding: 5px;
            cursor: pointer;
            margin-top: auto;
        }

        .inv-btn:hover {
            background: #666;
        }

        /* Equipment Slots */
        .equip-slots {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .equip-slot {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px dashed #666;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            color: #666;
            position: relative;
        }

        .unequip-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            border: none;
            color: white;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Skills/Talents */
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .skill-card {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 5px;
            opacity: 0.5;
        }

        .skill-card.unlocked {
            opacity: 1;
            border-color: #ffff00;
        }

        .skill-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }

        .skill-btn {
            background: #444;
            border: none;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        .skill-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .talent-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .talent-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }

        .talent-btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .talent-btn.disabled {
            background: #444;
            cursor: not-allowed;
        }

        #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: red;
            font-size: 48px;
            font-weight: bold;
            z-index: 200;
        }

        #gameOver button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="ui-layer">
        <div id="hud">
            <div class="bar-container">
                <div id="hp-bar-fill" class="bar-fill"></div>
                <div id="hp-text" class="bar-text">100/100</div>
            </div>
            <div class="bar-container">
                <div id="xp-bar-fill" class="bar-fill"></div>
                <div class="bar-text">XP</div>
            </div>
            <div class="bar-container" style="width: 200px;">
                <div id="energy-bar-fill" class="bar-fill"></div>
                <div class="bar-text">Energy</div>
            </div>
        </div>
        <div id="gold-display"
            style="position: absolute; top: 20px; right: 20px; font-size: 24px; color: #ffd700; font-weight: bold; text-shadow: 2px 2px 0 #000;">
            GOLD: <span id="playerGold">0</span>
        </div>
        <div id="quest-display"
            style="position: absolute; top: 60px; right: 20px; width: 250px; background: rgba(0,0,0,0.7); padding: 10px; border: 2px solid #aaa; border-radius: 5px;">
            <div style="color: #fff; font-weight: bold; margin-bottom: 5px;">CURRENT QUEST</div>
            <div id="quest-desc" style="color: #ddd; font-size: 14px;">Loading...</div>
            <div style="width: 100%; height: 10px; background: #333; margin-top: 5px;">
                <div id="quest-bar" style="width: 0%; height: 100%; background: #00ff00; transition: width 0.3s;"></div>
            </div>
        </div>

        <div id="skill-bar">
            <div class="skill-slot" id="skill-1"><span class="skill-key">1</span>⚔️<div id="cd-1" class="skill-cd">
                </div>
            </div>
            <div class="skill-slot" id="skill-2"><span class="skill-key">2</span>⚡<div id="cd-2" class="skill-cd"></div>
            </div>
            <div class="skill-slot" id="skill-3"><span class="skill-key">3</span>🛡️<div id="cd-3" class="skill-cd">
                </div>
            </div>
            <div class="skill-slot" id="skill-4"><span class="skill-key">4</span>🔥<div id="cd-4" class="skill-cd">
                </div>
            </div>
            <div class="skill-slot" id="skill-5"><span class="skill-key">5</span>❄️<div id="cd-5" class="skill-cd">
                </div>
            </div>
            <div class="skill-slot" id="skill-space" style="border-color: #f0f;"><span class="skill-key">SPC</span>💥
                <div id="cd-space" class="skill-cd"></div>
            </div>
        </div>

        <div id="statPanel">
            <div class="panel-header">
                <h2>Character Menu (Press C)</h2>
                <button onclick="toggleStats()"
                    style="background:none;border:none;color:white;font-size:20px;">X</button>
            </div>
            <div class="panel-tabs">
                <button class="tab-btn active" onclick="switchTab('stats')">Stats & Equip</button>
                <button class="tab-btn" onclick="switchTab('skills')">Skills</button>
                <button class="tab-btn" onclick="switchTab('talents')">Talents</button>
            </div>
            <div id="panel-stats" class="tab-content active">
                <div class="equip-slots">
                    <div class="equip-slot" id="eq-weapon">Weapon</div>
                    <div class="equip-slot" id="eq-armor">Armor</div>
                    <div class="equip-slot" id="eq-accessory">Accessory</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-row"><span>Level: </span><span id="playerLevel">1</span></div>
                    <div class="stat-row"><span>XP: </span><span id="playerXP">0/100</span></div>
                    <div class="stat-row"><span>HP: </span><span id="playerHP">100/100</span></div>
                    <div class="stat-row"><span>Energy: </span><span id="playerEnergy">100/100</span></div>
                    <div class="stat-row"><span>Attack: </span><span id="playerAttack">10</span><button class="stat-btn"
                            onclick="increaseStat('attack')">+</button></div>
                    <div class="stat-row"><span>Speed: </span><span id="playerSpeed">5</span><button class="stat-btn"
                            onclick="increaseStat('speed')">+</button></div>
                    <div class="stat-row"><span>Defense: </span><span id="playerDefense">0</span><button
                            class="stat-btn" onclick="increaseStat('defense')">+</button></div>
                    <div class="stat-row"><span>Crit Rate: </span><span id="playerCritRate">5%</span><button
                            class="stat-btn" onclick="increaseStat('critRate')">+</button></div>
                    <div class="stat-row"><span>Crit Dmg: </span><span id="playerCritDamage">150%</span><button
                            class="stat-btn" onclick="increaseStat('critDamage')">+</button></div>
                    <div class="stat-row"><span>Max HP: </span><span id="playerMaxHp">100</span><button class="stat-btn"
                            onclick="increaseStat('maxHp')">+</button></div>
                </div>
                <div id="statButtons" style="margin-top: 10px; color: #ffff00;">Points Available: <span
                        id="statPoints">0</span></div>
                <h3 style="margin-top: 20px; border-bottom: 1px solid #444;">Inventory</h3>
                <div id="inventoryList" class="inventory-grid"><!-- Items generated by JS --></div>
            </div>
            <div id="panel-skills" class="tab-content">
                <div style="width: 100%;">
                    <div class="stat-row"><span>Skill Points: </span><span id="skillPoints"
                            style="color: #ffff00;">0</span></div>
                    align-items: center;
                    }

                    /* Skills/Talents */
                    .skill-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                    gap: 15px;
                    }

                    .skill-card {
                    background: rgba(0, 0, 0, 0.5);
                    border: 1px solid #444;
                    padding: 10px;
                    border-radius: 5px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    text-align: center;
                    gap: 5px;
                    opacity: 0.5;
                    }

                    .skill-card.unlocked {
                    opacity: 1;
                    border-color: #ffff00;
                    }

                    .skill-icon {
                    font-size: 30px;
                    margin-bottom: 5px;
                    }

                    .skill-btn {
                    background: #444;
                    border: none;
                    color: white;
                    padding: 5px 10px;
                    cursor: pointer;
                    border-radius: 3px;
                    }

                    .skill-btn.disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                    }

                    .talent-list {
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    }

                    .talent-row {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background: rgba(0, 0, 0, 0.5);
                    padding: 10px;
                    border-radius: 5px;
                    }

                    .talent-btn {
                    background: #4CAF50;
                    border: none;
                    color: white;
                    padding: 5px 10px;
                    border-radius: 3px;
                    cursor: pointer;
                    }

                    .talent-btn.disabled {
                    background: #444;
                    cursor: not-allowed;
                    }

                    #gameOver {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: none;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    color: red;
                    font-size: 48px;
                    font-weight: bold;
                    z-index: 200;
                    }

                    #gameOver button {
                    margin-top: 20px;
                    padding: 10px 20px;
                    font-size: 24px;
                    cursor: pointer;
                    }
                    </style>
                    </head>

                    <body>
                        <div id="ui-layer">
                            <div id="hud">
                                <div class="bar-container">
                                    <div id="hp-bar-fill" class="bar-fill"></div>
                                    <div id="hp-text" class="bar-text">100/100</div>
                                </div>
                                <div class="bar-container">
                                    <div id="xp-bar-fill" class="bar-fill"></div>
                                    <div class="bar-text">XP</div>
                                </div>
                                <div class="bar-container" style="width: 200px;">
                                    <div id="energy-bar-fill" class="bar-fill"></div>
                                    <div class="bar-text">Energy</div>
                                </div>
                            </div>
                            <div id="gold-display"
                                style="position: absolute; top: 20px; right: 20px; font-size: 24px; color: #ffd700; font-weight: bold; text-shadow: 2px 2px 0 #000;">
                                GOLD: <span id="playerGold">0</span>
                            </div>
                            <div id="quest-display"
                                style="position: absolute; top: 60px; right: 20px; width: 250px; background: rgba(0,0,0,0.7); padding: 10px; border: 2px solid #aaa; border-radius: 5px;">
                                <div style="color: #fff; font-weight: bold; margin-bottom: 5px;">CURRENT QUEST</div>
                                <div id="quest-desc" style="color: #ddd; font-size: 14px;">Loading...</div>
                                <div style="width: 100%; height: 10px; background: #333; margin-top: 5px;">
                                    <div id="quest-bar"
                                        style="width: 0%; height: 100%; background: #00ff00; transition: width 0.3s;">
                                    </div>
                                </div>
                            </div>

                            <div id="skill-bar">
                                <div class="skill-slot" id="skill-1"><span class="skill-key">1</span>⚔️<div id="cd-1"
                                        class="skill-cd">
                                    </div>
                                </div>
                                <div class="skill-slot" id="skill-2"><span class="skill-key">2</span>⚡<div id="cd-2"
                                        class="skill-cd"></div>
                                </div>
                                <div class="skill-slot" id="skill-3"><span class="skill-key">3</span>🛡️<div id="cd-3"
                                        class="skill-cd">
                                    </div>
                                </div>
                                <div class="skill-slot" id="skill-4"><span class="skill-key">4</span>🔥<div id="cd-4"
                                        class="skill-cd">
                                    </div>
                                </div>
                                <div class="skill-slot" id="skill-5"><span class="skill-key">5</span>❄️<div id="cd-5"
                                        class="skill-cd">
                                    </div>
                                </div>
                                <div class="skill-slot" id="skill-space" style="border-color: #f0f;"><span
                                        class="skill-key">SPC</span>💥
                                    <div id="cd-space" class="skill-cd"></div>
                                </div>
                            </div>

                            <div id="statPanel">
                                <div class="panel-header">
                                    <h2>Character Menu (Press C)</h2>
                                    <button onclick="toggleStats()"
                                        style="background:none;border:none;color:white;font-size:20px;">X</button>
                                </div>
                                <div class="panel-tabs">
                                    <button class="tab-btn active" onclick="switchTab('stats')">Stats & Equip</button>
                                    <button class="tab-btn" onclick="switchTab('skills')">Skills</button>
                                    <button class="tab-btn" onclick="switchTab('talents')">Talents</button>
                                </div>
                                <div id="panel-stats" class="tab-content active">
                                    <div class="equip-slots">
                                        <div class="equip-slot" id="eq-weapon">Weapon</div>
                                        <div class="equip-slot" id="eq-armor">Armor</div>
                                        <div class="equip-slot" id="eq-accessory">Accessory</div>
                                    </div>
                                    <div class="stats-grid">
                                        <div class="stat-row"><span>Level: </span><span id="playerLevel">1</span></div>
                                        <div class="stat-row"><span>XP: </span><span id="playerXP">0/100</span></div>
                                        <div class="stat-row"><span>HP: </span><span id="playerHP">100/100</span></div>
                                        <div class="stat-row"><span>Energy: </span><span
                                                id="playerEnergy">100/100</span></div>
                                        <div class="stat-row"><span>Attack: </span><span
                                                id="playerAttack">10</span><button class="stat-btn"
                                                onclick="increaseStat('attack')">+</button></div>
                                        <div class="stat-row"><span>Speed: </span><span id="playerSpeed">5</span><button
                                                class="stat-btn" onclick="increaseStat('speed')">+</button></div>
                                        <div class="stat-row"><span>Defense: </span><span
                                                id="playerDefense">0</span><button class="stat-btn"
                                                onclick="increaseStat('defense')">+</button></div>
                                        <div class="stat-row"><span>Crit Rate: </span><span
                                                id="playerCritRate">5%</span><button class="stat-btn"
                                                onclick="increaseStat('critRate')">+</button></div>
                                        <div class="stat-row"><span>Crit Dmg: </span><span
                                                id="playerCritDamage">150%</span><button class="stat-btn"
                                                onclick="increaseStat('critDamage')">+</button></div>
                                        <div class="stat-row"><span>Max HP: </span><span
                                                id="playerMaxHp">100</span><button class="stat-btn"
                                                onclick="increaseStat('maxHp')">+</button></div>
                                    </div>
                                    <div id="statButtons" style="margin-top: 10px; color: #ffff00;">Points Available:
                                        <span id="statPoints">0</span>
                                    </div>
                                    <h3 style="margin-top: 20px; border-bottom: 1px solid #444;">Inventory</h3>
                                    <div id="inventoryList" class="inventory-grid"><!-- Items generated by JS --></div>
                                </div>
                                <div id="panel-skills" class="tab-content">
                                    <div style="width: 100%;">
                                        <div class="stat-row"><span>Skill Points: </span><span id="skillPoints"
                                                style="color: #ffff00;">0</span></div>
                                        <div id="skillGrid" class="skill-grid"><!-- Skills generated by JS --></div>
                                    </div>
                                </div>
                                <div id="panel-talents" class="tab-content">
                                    <div style="width: 100%;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <canvas id="gameCanvas"></canvas>
                        <div id="gameOver">
                            <h2>GAME OVER</h2>
                            <button onclick="resetGame()">TRY AGAIN</button>
                        </div>
                        <script src="Player.js"></script>
                        <script src="Enemy.js"></script>
                        <script> // Error Handling

                            window.onerror = function (msg, url, lineNo, columnNo, error) {
                                alert('Error: ' + msg + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nStack: ' + (error ? error.stack : 'N/A'));
                                return false;
                            };

                            const canvas = document.getElementById('gameCanvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = window.innerWidth;
                            canvas.height = window.innerHeight;

                            const TILE_SIZE = 64;
                            const MAP_SIZE = 64;

                            let player;
                            let enemies = [];
                            const ENEMY_COUNT = 150;
                            let bullets = [];
                            let items = [];
                            let effects = [];
                            let chests = [];
                            let floatingTexts = [];
                            let map = [];
                            let explored = [];

                            let portal = {
                                x: 0, y: 0, active: false
                            };
                            let stage = 1;

                            // Map Generation Safety
                            let mapRetries = 0;
                            const MAX_MAP_RETRIES = 50;

                            function toIso(x, y) {
                                return {
                                    x: (x - y) * TILE_SIZE / 2,
                                    y: (x + y) * TILE_SIZE / 4
                                };
                            }

                            function isSolid(x, y) {
                                let gridX = Math.floor(x);
                                let gridY = Math.floor(y);
                                if (gridX < 0 || gridX >= MAP_SIZE || gridY < 0 || gridY >= MAP_SIZE) return true;
                                return map[gridY][gridX] === 1;
                            }

                            function generateMap() {
                                if (mapRetries > MAX_MAP_RETRIES) {
                                    console.warn("Failed to generate a valid map after " + MAX_MAP_RETRIES + " attempts. Using fallback map.");
                                    map.length = 0;
                                    explored.length = 0;

                                    for (let y = 0; y < MAP_SIZE; y++) {
                                        let row = [];
                                        let expRow = [];

                                        for (let x = 0; x < MAP_SIZE; x++) {
                                            if (x === 0 || x === MAP_SIZE - 1 || y === 0 || y === MAP_SIZE - 1) row.push(1);
                                            else row.push(0);
                                            expRow.push(false);
                                        }

                                        map.push(row);
                                        explored.push(expRow);
                                    }

                                    player.x = MAP_SIZE / 2;
                                    player.y = MAP_SIZE / 2;
                                    spawnPortal();
                                    return;
                                }

                                map.length = 0;
                                explored.length = 0;

                                for (let y = 0; y < MAP_SIZE; y++) {
                                    let row = [];
                                    let expRow = [];

                                    for (let x = 0; x < MAP_SIZE; x++) {
                                        if (x === 0 || x === MAP_SIZE - 1 || y === 0 || y === MAP_SIZE - 1) {
                                            row.push(1);
                                        } else {
                                            row.push(Math.random() < 0.45 ? 1 : 0);
                                        }
                                        expRow.push(false);
                                    }

                                    map.push(row);
                                    explored.push(expRow);
                                }

                                // Cellular Automata
                                for (let i = 0; i < 5; i++) {
                                    let newMap = JSON.parse(JSON.stringify(map));

                                    for (let y = 1; y < MAP_SIZE - 1; y++) {
                                        for (let x = 1; x < MAP_SIZE - 1; x++) {
                                            let neighbors = 0;

                                            for (let dy = -1; dy <= 1; dy++) {
                                                for (let dx = -1; dx <= 1; dx++) {
                                                    if (map[y + dy][x + dx] === 1) neighbors++;
                                                }
                                            }

                                            if (neighbors > 4) newMap[y][x] = 1;
                                            else if (neighbors < 4) newMap[y][x] = 0;
                                        }
                                    }

                                    for (let y = 0; y < MAP_SIZE; y++) {
                                        for (let x = 0; x < MAP_SIZE; x++) {
                                            map[y][x] = newMap[y][x];
                                        }
                                    }
                                }

                                // Region connection (Simplified)
                                let regions = [];
                                let visited = Array(MAP_SIZE).fill().map(() => Array(MAP_SIZE).fill(false));

                                for (let y = 1; y < MAP_SIZE - 1; y++) {
                                    for (let x = 1; x < MAP_SIZE - 1; x++) {
                                        if (map[y][x] === 0 && !visited[y][x]) {
                                            let region = [];
                                            let stack = [{ x, y }];
                                            visited[y][x] = true;

                                            while (stack.length > 0) {
                                                let p = stack.pop();
                                                region.push(p);

                                                [[0, 1], [0, -1], [1, 0], [-1, 0]].forEach(([dx, dy]) => {
                                                    let nx = p.x + dx;
                                                    let ny = p.y + dy;

                                                    if (nx >= 0 && nx < MAP_SIZE && ny >= 0 && ny < MAP_SIZE && map[ny][nx] === 0 && !visited[ny][nx]) {
                                                        visited[ny][nx] = true;
                                                        stack.push({ x: nx, y: ny });
                                                    }
                                                });
                                            }

                                            regions.push(region);
                                        }
                                    }
                                }

                                if (regions.length === 0) {
                                    mapRetries++;
                                    generateMap();
                                    return;
                                }

                                regions.sort((a, b) => b.length - a.length);
                                let largest = regions[0];

                                if (largest.length < MAP_SIZE * MAP_SIZE * 0.1) {
                                    mapRetries++;
                                    generateMap();
                                    return;
                                }

                                // Fill small regions
                                for (let i = 1; i < regions.length; i++) {
                                    regions[i].forEach(p => map[p.y][p.x] = 1);
                                }

                                // Spawn Player
                                let spawn = largest[Math.floor(Math.random() * largest.length)];
                                player.x = spawn.x;
                                player.y = spawn.y;

                                // Spawn Chests
                                chests = [];
                                for (let i = 0; i < 5; i++) {
                                    let valid = false;
                                    let attempts = 0;
                                    while (!valid && attempts < 50) {
                                        let x = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                        let y = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                        if (map[y][x] === 0 && Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) > 10) {
                                            chests.push({ x, y });
                                            valid = true;
                                        }
                                        attempts++;
                                    }
                                }

                                spawnPortal();
                            }

                            function spawnPortal() {
                                let valid = false;
                                let attempts = 0;

                                while (!valid && attempts < 1000) {
                                    let x = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                    let y = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;

                                    if (map[y][x] === 0 && Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) > 20) {
                                        portal.x = x;
                                        portal.y = y;
                                        portal.active = false;
                                        valid = true;
                                    }
                                    attempts++;
                                }

                                if (!valid) {
                                    portal.x = player.x;
                                    portal.y = player.y;
                                    console.warn("Portal spawn fallback");
                                }
                            }

                            function resetGame() {
                                player = new Player(10, 10);
                                generateMap();
                                enemies = [];
                                bullets = [];
                                items = [];
                                effects = [];
                                chests = [];
                                floatingTexts = [];
                                for (let i = 0; i < ENEMY_COUNT + stage * 10; i++) {
                                    let valid = false;
                                    let attempts = 0;
                                    while (!valid && attempts < 100) {
                                        let x = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                        let y = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                    }

                                    function isSolid(x, y) {
                                        let gridX = Math.floor(x);
                                        let gridY = Math.floor(y);
                                        if (gridX < 0 || gridX >= MAP_SIZE || gridY < 0 || gridY >= MAP_SIZE) return true;
                                        return map[gridY][gridX] === 1;
                                    }

                                    function generateMap() {
                                        if (mapRetries > MAX_MAP_RETRIES) {
                                            console.warn("Failed to generate a valid map after " + MAX_MAP_RETRIES + " attempts. Using fallback map.");
                                            map.length = 0;
                                            explored.length = 0;

                                            for (let y = 0; y < MAP_SIZE; y++) {
                                                let row = [];
                                                let expRow = [];

                                                for (let x = 0; x < MAP_SIZE; x++) {
                                                    if (x === 0 || x === MAP_SIZE - 1 || y === 0 || y === MAP_SIZE - 1) row.push(1);
                                                    else row.push(0);
                                                    expRow.push(false);
                                                }

                                                map.push(row);
                                                explored.push(expRow);
                                            }

                                            player.x = MAP_SIZE / 2;
                                            player.y = MAP_SIZE / 2;
                                            spawnPortal();
                                            return;
                                        }

                                        map.length = 0;
                                        explored.length = 0;

                                        for (let y = 0; y < MAP_SIZE; y++) {
                                            let row = [];
                                            let expRow = [];

                                            for (let x = 0; x < MAP_SIZE; x++) {
                                                if (x === 0 || x === MAP_SIZE - 1 || y === 0 || y === MAP_SIZE - 1) {
                                                    row.push(1);
                                                } else {
                                                    row.push(Math.random() < 0.45 ? 1 : 0);
                                                }
                                                expRow.push(false);
                                            }

                                            map.push(row);
                                            explored.push(expRow);
                                        }

                                        // Cellular Automata
                                        for (let i = 0; i < 5; i++) {
                                            let newMap = JSON.parse(JSON.stringify(map));

                                            for (let y = 1; y < MAP_SIZE - 1; y++) {
                                                for (let x = 1; x < MAP_SIZE - 1; x++) {
                                                    let neighbors = 0;

                                                    for (let dy = -1; dy <= 1; dy++) {
                                                        for (let dx = -1; dx <= 1; dx++) {
                                                            if (map[y + dy][x + dx] === 1) neighbors++;
                                                        }
                                                    }

                                                    if (neighbors > 4) newMap[y][x] = 1;
                                                    else if (neighbors < 4) newMap[y][x] = 0;
                                                }
                                            }

                                            for (let y = 0; y < MAP_SIZE; y++) {
                                                for (let x = 0; x < MAP_SIZE; x++) {
                                                    map[y][x] = newMap[y][x];
                                                }
                                            }
                                        }

                                        // Region connection (Simplified)
                                        let regions = [];
                                        let visited = Array(MAP_SIZE).fill().map(() => Array(MAP_SIZE).fill(false));

                                        for (let y = 1; y < MAP_SIZE - 1; y++) {
                                            for (let x = 1; x < MAP_SIZE - 1; x++) {
                                                if (map[y][x] === 0 && !visited[y][x]) {
                                                    let region = [];
                                                    let stack = [{ x, y }];
                                                    visited[y][x] = true;

                                                    while (stack.length > 0) {
                                                        let p = stack.pop();
                                                        region.push(p);

                                                        [[0, 1], [0, -1], [1, 0], [-1, 0]].forEach(([dx, dy]) => {
                                                            let nx = p.x + dx;
                                                            let ny = p.y + dy;

                                                            if (nx >= 0 && nx < MAP_SIZE && ny >= 0 && ny < MAP_SIZE && map[ny][nx] === 0 && !visited[ny][nx]) {
                                                                visited[ny][nx] = true;
                                                                stack.push({ x: nx, y: ny });
                                                            }
                                                        });
                                                    }

                                                    regions.push(region);
                                                }
                                            }
                                        }

                                        if (regions.length === 0) {
                                            mapRetries++;
                                            generateMap();
                                            return;
                                        }

                                        regions.sort((a, b) => b.length - a.length);
                                        let largest = regions[0];

                                        if (largest.length < MAP_SIZE * MAP_SIZE * 0.1) {
                                            mapRetries++;
                                            generateMap();
                                            return;
                                        }

                                        // Fill small regions
                                        for (let i = 1; i < regions.length; i++) {
                                            regions[i].forEach(p => map[p.y][p.x] = 1);
                                        }

                                        // Spawn Player
                                        let spawn = largest[Math.floor(Math.random() * largest.length)];
                                        player.x = spawn.x;
                                        player.y = spawn.y;

                                        // Spawn Chests
                                        chests = [];
                                        for (let i = 0; i < 5; i++) {
                                            let valid = false;
                                            let attempts = 0;
                                            while (!valid && attempts < 50) {
                                                let x = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                                let y = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                                if (map[y][x] === 0 && Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) > 10) {
                                                    chests.push({ x, y });
                                                    valid = true;
                                                }
                                                attempts++;
                                            }
                                        }

                                        spawnPortal();
                                    }

                                    function spawnPortal() {
                                        let valid = false;
                                        let attempts = 0;

                                        while (!valid && attempts < 1000) {
                                            let x = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                            let y = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;

                                            if (map[y][x] === 0 && Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) > 20) {
                                                portal.x = x;
                                                portal.y = y;
                                                portal.active = false;
                                                valid = true;
                                            }
                                            attempts++;
                                        }

                                        if (!valid) {
                                            portal.x = player.x;
                                            portal.y = player.y;
                                            console.warn("Portal spawn fallback");
                                        }
                                    }

                                    function resetGame() {
                                        player = new Player(10, 10);
                                        generateMap();
                                        enemies = [];
                                        bullets = [];
                                        items = [];
                                        effects = [];
                                        chests = [];
                                        floatingTexts = [];
                                        for (let i = 0; i < ENEMY_COUNT + stage * 10; i++) {
                                            let valid = false;
                                            let attempts = 0;
                                            while (!valid && attempts < 100) {
                                                let x = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                                let y = Math.floor(Math.random() * (MAP_SIZE - 2)) + 1;
                                                if (map[y][x] === 0 && Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) > 10) {
                                                    enemies.push(new Enemy(x, y, stage));
                                                    valid = true;
                                                }
                                                attempts++;
                                            }
                                        }
                                    }

                                    function update() {
                                        // Player movement
                                        let dx = 0;
                                        let dy = 0;
                                        if (keys['w']) { dx += 1; dy -= 1; }
                                        if (keys['s']) { dx -= 1; dy += 1; }
                                        if (keys['a']) { dx -= 1; dy -= 1; }
                                        if (keys['d']) { dx += 1; dy += 1; }

                                        player.move(dx, dy, map);

                                        // Player attack
                                        if (keys[' ']) { player.attack(enemies, bullets); }

                                        // Skill usage
                                        if (keys['1']) player.useSkill(0, enemies, bullets);
                                        if (keys['2']) player.useSkill(1, enemies, bullets);
                                        if (keys['3']) player.useSkill(2, enemies, bullets);
                                        if (keys['4']) player.useSkill(3, enemies, bullets);
                                        if (keys['5']) player.useSkill(4, enemies, bullets);

                                        // Toggle Stats Panel
                                        if (keys['c'] && !player.cPressed) {
                                            toggleStats();
                                            player.cPressed = true;
                                        } else if (!keys['c']) {
                                            player.cPressed = false;
                                        }

                                        // Update Player
                                        player.update();

                                        // Update Enemies
                                        enemies.forEach(e => e.update(player, map, enemies));
                                        enemies = enemies.filter(e => e.hp > 0);

                                        // Update Bullets
                                        bullets.forEach(b => {
                                            b.x += b.vx;
                                            b.y += b.vy;
                                            b.life--;

                                            // Collision with enemies
                                            enemies.forEach(e => {
                                                if (Math.sqrt((b.x - e.x) ** 2 + (b.y - e.y) ** 2) < 0.5) {
                                                    e.takeDamage(player.stats.attack);
                                                    b.life = 0;
                                                    spawnFloatingText(e.x, e.y, Math.floor(player.stats.attack), '#fff', 20);
                                                    // Knockback
                                                    const angle = Math.atan2(e.y - b.y, e.x - b.x);
                                                    e.x += Math.cos(angle) * 0.5;
                                                    e.y += Math.sin(angle) * 0.5;
                                                }
                                            });
                                        });
                                        bullets = bullets.filter(b => b.life > 0 && map[Math.floor(b.y)][Math.floor(b.x)] === 0);

                                        // Update Effects
                                        effects.forEach(e => {
                                            if (e.type === 'nova') {
                                                e.radius += 0.2;
                                                e.life--;
                                            } else if (e.type === 'levelup') {
                                                e.radius += 0.1;
                                                e.life--;
                                            } else if (e.type === 'lightning') {
                                                e.life--;
                                            }
                                        });
                                        effects = effects.filter(e => e.life > 0);

                                        // Item Pickup
                                        items.forEach(item => {
                                            if (Math.sqrt((player.x - item.x) ** 2 + (player.y - item.y) ** 2) < 1) {
                                                if (item.type === 0) {
                                                    player.hp = Math.min(player.hp + 20, player.stats.maxHp);
                                                    spawnFloatingText(player.x, player.y, "+20 HP", '#0f0', 20);
                                                } else if (item.type === 7) {
                                                    player.gold += 10;
                                                    spawnFloatingText(player.x, player.y, "+10 G", '#ffd700', 20);
                                                } else {
                                                    // Equipment
                                                    if (player.inventory.length < 20) {
                                                        player.inventory.push(item);
                                                        spawnFloatingText(player.x, player.y, "ITEM", '#fff', 20);
                                                        updateInventoryUI();
                                                    }
                                                }
                                                item.life = 0;
                                            }
                                        });
                                        items = items.filter(i => i.life > 0);

                                        // Portal Activation
                                        if (!portal.active && enemies.length === 0) {
                                            portal.active = true;
                                            spawnFloatingText(portal.x, portal.y, "PORTAL OPEN", '#0ff', 30);
                                        }

                                        updateFog();
                                        updateHUD();
                                    }

                                    // Input
                                    const keys = {};
                                    window.addEventListener('keydown', e => {
                                        keys[e.key] = true;
                                        if (e.key === 'e' || e.key === 'E') {
                                            if (portal.active && Math.sqrt((player.x - portal.x) ** 2 + (player.y - portal.y) ** 2) < 2) {
                                                // nextStage();
                                                console.log("Portal interaction");
                                            }
                                        }
                                    });
                                    window.addEventListener('keyup', e => keys[e.key] = false);

                                    function draw() {
                                        ctx.fillStyle = '#000';
                                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                                        const cameraX = canvas.width / 2 - (player.x - player.y) * TILE_SIZE / 2;
                                        const cameraY = canvas.height / 2 - (player.x + player.y) * TILE_SIZE / 4;

                                        // Draw Map
                                        for (let y = 0; y < MAP_SIZE; y++) {
                                            for (let x = 0; x < MAP_SIZE; x++) {
                                                const iso = toIso(x, y);
                                                const screenX = iso.x + cameraX;
                                                const screenY = iso.y + cameraY;

                                                if (screenX < -TILE_SIZE || screenX > canvas.width + TILE_SIZE || screenY < -TILE_SIZE || screenY > canvas.height + TILE_SIZE) continue;

                                                if (map[y][x] === 1) {
                                                    // Wall
                                                    ctx.fillStyle = '#444';
                                                    ctx.beginPath();
                                                    ctx.moveTo(screenX, screenY - 32);
                                                    ctx.lineTo(screenX + 32, screenY - 16);
                                                    ctx.lineTo(screenX, screenY);
                                                    ctx.lineTo(screenX, screenY + 32);
                                                    ctx.lineTo(screenX - 32, screenY + 16);
                                                    ctx.fill();
                                                    ctx.stroke();

                                                    ctx.fillStyle = '#111';
                                                    ctx.beginPath();
                                                    ctx.moveTo(screenX, screenY);
                                                    ctx.lineTo(screenX + 32, screenY - 16);
                                                    ctx.lineTo(screenX + 32, screenY + 16);
                                                    ctx.lineTo(screenX, screenY + 32);
                                                    ctx.fill();
                                                    ctx.stroke();
                                                } else {
                                                    // Floor
                                                    ctx.fillStyle = '#222';
                                                    ctx.beginPath();
                                                    ctx.moveTo(screenX, screenY);
                                                    ctx.lineTo(screenX + 32, screenY - 16);
                                                    ctx.lineTo(screenX + 64, screenY);
                                                    ctx.lineTo(screenX + 32, screenY + 16);
                                                    ctx.fill();
                                                    ctx.strokeStyle = '#333';
                                                    ctx.stroke();
                                                }
                                            }
                                        }

                                        // Draw Items
                                        items.forEach(item => {
                                            const iso = toIso(item.x, item.y);
                                            const screenX = iso.x + cameraX;
                                            const screenY = iso.y + cameraY;

                                            let color = '#fff';
                                            let text = '?';

                                            if (item.type === 0) { color = '#00ff00'; text = 'HP'; }
                                            else if (item.type === 1) { color = '#ff0000'; text = 'SG'; }
                                            else if (item.type === 2) { color = '#ffff00'; text = 'MG'; }
                                            else if (item.type === 3) { color = '#00ff00'; text = 'SR'; }
                                            else if (item.type === 4) { color = '#00ffff'; text = 'EQ'; }
                                            else if (item.type === 5) { color = '#ff00ff'; text = 'EQ'; }
                                            else if (item.type === 6) { color = '#ffffff'; text = 'EQ'; }
                                            else if (item.type === 7) { color = '#ffd700'; text = 'G'; }

                                            ctx.fillStyle = color;
                                            ctx.fillRect(screenX - 10, screenY - 20, 20, 20);
                                            ctx.strokeStyle = '#fff';
                                            ctx.strokeRect(screenX - 10, screenY - 20, 20, 20);
                                            ctx.fillStyle = '#000';
                                            ctx.font = '12px Arial';
                                            ctx.fillText(text, screenX - 6, screenY - 6);
                                        });

                                        // Draw Enemies
                                        enemies.forEach(e => {
                                            if (!explored[Math.floor(e.y)] || !explored[Math.floor(e.y)][Math.floor(e.x)]) return;
                                            const iso = toIso(e.x, e.y);
                                            e.draw(ctx, iso.x + cameraX, iso.y + cameraY);
                                        });

                                        // Draw Player
                                        const isoPlayer = toIso(player.x, player.y);
                                        player.draw(ctx, isoPlayer.x + cameraX, isoPlayer.y + cameraY);

                                        // Draw Bullets
                                        bullets.forEach(b => {
                                            const iso = toIso(b.x, b.y);
                                            const screenX = iso.x + cameraX;
                                            const screenY = iso.y + cameraY;

                                            ctx.fillStyle = b.color;
                                            ctx.beginPath();
                                            ctx.arc(screenX, screenY, 4, 0, Math.PI * 2);
                                            ctx.fill();
                                        });

                                        // Draw Effects
                                        effects.forEach(e => {
                                            const iso = toIso(e.x, e.y);
                                            const screenX = iso.x + cameraX;
                                            const screenY = iso.y + cameraY;

                                            ctx.globalAlpha = e.life / 30;

                                            if (e.type === 'nova') {
                                                ctx.fillStyle = e.color;
                                                ctx.beginPath();
                                                ctx.arc(screenX, screenY, e.radius * 20, 0, Math.PI * 2);
                                                ctx.fill();
                                            } else if (e.type === 'levelup') {
                                                ctx.strokeStyle = e.color;
                                                ctx.lineWidth = 2;
                                                ctx.beginPath();
                                                ctx.ellipse(screenX, screenY + 10, e.radius * 20, e.radius * 10, 0, 0, Math.PI * 2);
                                                ctx.stroke();
                                                e.radius += 0.1;
                                            } else if (e.type === 'lightning') {
                                                ctx.strokeStyle = '#ffff00';
                                                ctx.lineWidth = 1;
                                                ctx.beginPath();
                                                ctx.moveTo(screenX, screenY);
                                                ctx.lineTo(screenX + (Math.random() - 0.5) * 50, screenY - 50 + (Math.random() - 0.5) * 50);
                                                ctx.stroke();
                                            }
                                        });

                                        // Draw Floating Texts
                                        floatingTexts.forEach(ft => {
                                            const iso = toIso(ft.x, ft.y);
                                            const screenX = iso.x + cameraX;
                                            const screenY = iso.y + cameraY - 40 + (60 - ft.life);
                                            ctx.fillStyle = ft.color;
                                            ctx.font = `bold ${ft.size}px Arial`;
                                            ctx.fillText(ft.text, screenX, screenY);
                                            ft.life--;
                                        });
                                        floatingTexts = floatingTexts.filter(ft => ft.life > 0);

                                        ctx.globalAlpha = 1.0;
                                    }

                                    function spawnItem(x, y) {
                                        const type = Math.floor(Math.random() * 8); // 0-3: weapons/hp, 4-6: equip, 7: gold
                                        let item = { x, y, type, life: 600 };

                                        if (type === 4) item = { ...item, ...generateEquipment('weapon'), color: '#00ffff' };
                                        else if (type === 5) item = { ...item, ...generateEquipment('armor'), color: '#ff00ff' };
                                        else if (type === 6) item = { ...item, ...generateEquipment('accessory'), color: '#ffffff' };
                                        else if (type === 7) item.color = '#ffd700'; // Gold

                                        items.push(item);
                                    }

                                    function generateEquipment(type) {
                                        const rarity = Math.random();
                                        let quality = 1;
                                        if (rarity > 0.9) quality = 3;
                                        else if (rarity > 0.7) quality = 2;

                                        const stats = {
                                            attack: type === 'weapon' ? Math.floor(Math.random() * 5 * quality) + 1 : 0,
                                            defense: type === 'armor' ? Math.floor(Math.random() * 3 * quality) + 1 : 0,
                                            speed: type === 'accessory' ? Math.random() * 0.5 * quality : 0,
                                            maxHp: Math.floor(Math.random() * 20 * quality),
                                            critRate: Math.random() * 0.05 * quality,
                                            critDamage: Math.random() * 0.2 * quality
                                        };

                                        const namePrefix = quality === 3 ? 'Legendary' : (quality === 2 ? 'Rare' : 'Common');
                                        return {
                                            name: `${namePrefix} ${type.charAt(0).toUpperCase() + type.slice(1)}`,
                                            stats,
                                            slot: type
                                        };
                                    }

                                    function toggleStats() {
                                        const ui = document.getElementById('ui-layer');
                                        ui.style.display = ui.style.display === 'none' ? 'flex' : 'none';
                                        if (ui.style.display === 'flex') {
                                            updateStatUI();
                                            updateInventoryUI();
                                        }
                                    }

                                    function switchTab(tabName) {
                                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                                        document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));

                                        const btn = document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`);
                                        if (btn) btn.classList.add('active');

                                        const panel = document.getElementById(`panel-${tabName}`);
                                        if (panel) panel.classList.add('active');
                                    }

                                    function increaseStat(stat) {
                                        if (player.statPoints > 0) {
                                            if (stat === 'attack') player.baseStats.attack += 1;
                                            else if (stat === 'speed') player.baseStats.speed += 0.1;
                                            else if (stat === 'critRate') player.baseStats.critRate += 0.01;
                                            else if (stat === 'critDamage') player.baseStats.critDamage += 0.1;
                                            else if (stat === 'maxHp') {
                                                player.baseStats.maxHp += 10;
                                                player.hp += 10;
                                            }
                                            else if (stat === 'defense') {
                                                player.baseStats.defense += 1;
                                            }
                                            player.statPoints--;
                                            updateStatUI();
                                        }
                                    }

                                    function updateStatUI() {
                                        document.getElementById('playerLevel').innerText = player.level;
                                        document.getElementById('playerXP').innerText = `${Math.floor(player.xp)} / ${player.xpToNextLevel}`;
                                        document.getElementById('playerHP').innerText = `${Math.floor(player.hp)} / ${player.stats.maxHp}`;
                                        document.getElementById('playerEnergy').innerText = `${Math.floor(player.energy)} / ${player.maxEnergy}`;
                                        document.getElementById('playerAttack').innerText = player.stats.attack.toFixed(1);
                                        document.getElementById('playerSpeed').innerText = player.stats.speed.toFixed(2);
                                        document.getElementById('playerDefense').innerText = player.stats.defense.toFixed(0);
                                        document.getElementById('playerCritRate').innerText = (player.stats.critRate * 100).toFixed(1) + '%';
                                        document.getElementById('playerCritDamage').innerText = (player.stats.critDamage * 100).toFixed(0) + '%';
                                        document.getElementById('playerMaxHp').innerText = player.stats.maxHp;
                                        document.getElementById('statPoints').innerText = player.statPoints;
                                        document.getElementById('statButtons').style.display = player.statPoints > 0 ? 'block' : 'none';
                                        updateSkillUI();
                                        updateTalentUI();
                                    }

                                    function unlockSkill(index) {
                                        if (player.unlockSkill(index)) {
                                            updateSkillUI();
                                            updateHUD();
                                        }
                                    }

                                    function updateSkillUI() {
                                        const grid = document.getElementById('skillGrid');
                                        grid.innerHTML = '';
                                        document.getElementById('skillPoints').innerText = player.skillPoints;

                                        player.SKILLS.forEach((skill, index) => {
                                            const card = document.createElement('div');
                                            card.className = `skill-card ${skill.unlocked ? 'unlocked' : 'locked'}`;

                                            const btnClass = (player.skillPoints > 0 && player.level >= skill.levelReq && !skill.unlocked) ? 'skill-btn' : 'skill-btn disabled';
                                            const btnText = skill.unlocked ? 'UNLOCKED' : (player.level >= skill.levelReq ? 'UNLOCK' : `LVL ${skill.levelReq}`);
                                            const btnAction = (player.skillPoints > 0 && player.level >= skill.levelReq && !skill.unlocked) ? `onclick="unlockSkill(${index})"` : '';

                                            card.innerHTML = `<div class="skill-icon">${skill.icon}</div>
                                        <div class="skill-info" style="width:100%">
                                            <div class="skill-name">${skill.name}</div>
                                            <div class="skill-desc">${skill.desc}</div>
                                        </div>
                                        <button class="${btnClass}" ${btnAction}>${btnText}</button>`;
                                            grid.appendChild(card);
                                        });
                                    }

                                    function updateTalentUI() {
                                        const list = document.getElementById('talentList');
                                        list.innerHTML = '';
                                        document.getElementById('talentPoints').innerText = player.talentPoints;

                                        player.TALENTS.forEach((talent, index) => {
                                            const row = document.createElement('div');
                                            row.className = 'talent-row';

                                            const canUpgrade = player.talentPoints > 0 && talent.level < talent.maxLevel;
                                            const btnClass = canUpgrade ? 'talent-btn' : 'talent-btn disabled';
                                            const btnAction = canUpgrade ? `onclick="upgradeTalent(${index})"` : '';

                                            row.innerHTML = `<div class="talent-info">
                                            <div class="talent-name">${talent.name} <span style="color:#666; font-size:12px;">(Lvl ${talent.level}/${talent.maxLevel})</span></div>
                                            <div class="talent-desc">${talent.desc}</div>
                                        </div>
                                        <button class="${btnClass}" ${btnAction}>UPGRADE</button>`;
                                            list.appendChild(row);
                                        });
                                    }

                                    function upgradeTalent(index) {
                                        if (player.upgradeTalent(index)) {
                                            updateTalentUI();
                                            updateStatUI();
                                        }
                                    }

                                    function updateInventoryUI() {
                                        const list = document.getElementById('inventoryList');
                                        list.innerHTML = '';

                                        if (player.inventory.length === 0) {
                                            list.innerHTML = '<p style="color:#666;">Inventory is empty.</p>';
                                        } else {
                                            player.inventory.forEach((item, index) => {
                                                const div = document.createElement('div');
                                                div.className = 'inv-item';
                                                let statsStr = '';

                                                if (item.stats.attack) statsStr += `ATK: +${item.stats.attack} `;
                                                if (item.stats.speed) statsStr += `SPD: +${item.stats.speed.toFixed(2)} `;
                                                if (item.stats.maxHp) statsStr += `HP: +${item.stats.maxHp} `;
                                                if (item.stats.defense) statsStr += `DEF: +${item.stats.defense} `;
                                                if (item.stats.critRate) statsStr += `CRIT %: +${(item.stats.critRate * 100).toFixed(1)}% `;
                                                if (item.stats.critDamage) statsStr += `CRIT DMG: +${item.stats.critDamage.toFixed(1)} `;

                                                div.innerHTML = `<div>
                                            <span class="inv-name" style="color:${item.color}">${item.name}</span>
                                            <span style="color:#666; font-size:10px;">${statsStr}</span>
                                        </div>
                                        <button class="inv-btn" onclick="equipItem(${index})">EQUIP</button>`;
                                                list.appendChild(div);
                                            });
                                        }

                                        // Update Equipped
                                        const eqWeapon = document.getElementById('eq-weapon');
                                        const eqArmor = document.getElementById('eq-armor');
                                        const eqAccessory = document.getElementById('eq-accessory');

                                        if (player.equipment.weapon) {
                                            eqWeapon.innerHTML = `<span style="color:${player.equipment.weapon.color}">${player.equipment.weapon.name}</span>
                                        <button class="unequip-btn" onclick="unequipItem('weapon')">X</button>`;
                                        } else {
                                            eqWeapon.textContent = 'None';
                                        }

                                        if (player.equipment.armor) {
                                            eqArmor.innerHTML = `<span style="color:${player.equipment.armor.color}">${player.equipment.armor.name}</span>
                                        <button class="unequip-btn" onclick="unequipItem('armor')">X</button>`;
                                        } else {
                                            eqArmor.textContent = 'None';
                                        }

                                        if (player.equipment.accessory) {
                                            eqAccessory.innerHTML = `<span style="color:${player.equipment.accessory.color}">${player.equipment.accessory.name}</span>
                                        <button class="unequip-btn" onclick="unequipItem('accessory')">X</button>`;
                                        } else {
                                            eqAccessory.textContent = 'None';
                                        }
                                    }

                                    function equipItem(index) {
                                        const item = player.inventory[index];
                                        const slot = item.slot;

                                        if (!slot) return;

                                        // Unequip current if exists
                                        if (player.equipment[slot]) {
                                            player.inventory.push(player.equipment[slot]);
                                        }

                                        player.equipment[slot] = item;
                                        player.inventory.splice(index, 1);
                                        updateInventoryUI();
                                        updateStatUI();
                                    }

                                    function unequipItem(slot) {
                                        if (player.equipment[slot]) {
                                            player.inventory.push(player.equipment[slot]);
                                            player.equipment[slot] = null;
                                            updateInventoryUI();
                                            updateStatUI();
                                        }
                                    }

                                    function spawnFloatingText(x, y, text, color, size) {
                                        floatingTexts.push({
                                            x, y, text, color, size, life: 60
                                        });
                                    }

                                    function updateFog() {
                                        const range = 8;
                                        for (let y = Math.max(0, Math.floor(player.y - range)); y < Math.min(MAP_SIZE, Math.floor(player.y + range)); y++) {
                                            for (let x = Math.max(0, Math.floor(player.x - range)); x < Math.min(MAP_SIZE, Math.floor(player.x + range)); x++) {
                                                if (Math.sqrt((x - player.x) ** 2 + (y - player.y) ** 2) < range) {
                                                    explored[y][x] = true;
                                                }
                                            }
                                        }
                                    }

                                    function updateHUD() {
                                        // Debug Info
                                        let debugEl = document.getElementById('debug-info');
                                        if (!debugEl) {
                                            debugEl = document.createElement('div');
                                            debugEl.id = 'debug-info';
                                            debugEl.style.position = 'absolute';
                                            debugEl.style.top = '60px';
                                            debugEl.style.left = '10px';
                                            debugEl.style.color = 'white';
                                            debugEl.style.fontFamily = 'monospace';
                                            debugEl.style.backgroundColor = 'rgba(0,0,0,0.5)';
                                            debugEl.style.padding = '5px';
                                            debugEl.style.pointerEvents = 'none';
                                            document.body.appendChild(debugEl);
                                        }
                                        const dist = Math.sqrt((player.x - portal.x) ** 2 + (player.y - portal.y) ** 2);
                                        debugEl.innerHTML = `Enemies: ${enemies.length}<br>
                                    Portal Active: ${portal.active}<br>
                                    Dist to Portal: ${dist.toFixed(2)}<br>
                                    Player: (${player.x.toFixed(1)}, ${player.y.toFixed(1)})<br>
                                    Portal: (${portal.x.toFixed(1)}, ${portal.y.toFixed(1)})`;

                                        // HP Bar
                                        const hpPercent = (player.hp / player.stats.maxHp) * 100;
                                        document.getElementById('hp-bar-fill').style.width = hpPercent + '%';
                                        document.getElementById('hp-text').innerText = `${Math.ceil(player.hp)} / ${player.stats.maxHp}`;

                                        // XP Bar
                                        const xpPercent = (player.xp / player.xpToNextLevel) * 100;
                                        document.getElementById('xp-bar-fill').style.width = xpPercent + '%';

                                        // Energy Bar
                                        const energyPercent = (player.energy / player.maxEnergy) * 100;
                                        document.getElementById('energy-bar-fill').style.width = energyPercent + '%';

                                        // Skill Cooldowns
                                        player.SKILLS.forEach((skill, index) => {
                                            let id = index + 1;
                                            if (index === 5) id = 'space';

                                            const cdEl = document.getElementById(`cd-${id}`);

                                            if (cdEl) {
                                                const percent = (skill.cooldown / skill.maxCooldown) * 100;
                                                cdEl.style.height = percent + '%';
                                            }
                                        });
                                    }

                                    // Init
                                    try {
                                        resetGame();
                                        animate();
                                    } catch (e) {
                                        console.error("Game Init Error:", e);
                                        alert("Game Init Error: " + e.message);
                                    }
                        </script>
                    </body>

</html>